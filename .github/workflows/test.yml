name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  SCHEME: BombermanGame
  PROJECT_PATH: BombermanGame/BombermanGame.xcodeproj

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: macos-15
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Select Xcode Version
      run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
      
    - name: Show Available Simulators
      run: xcrun simctl list devices available
      
    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-test-deriveddata-${{ hashFiles('**/*.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-test-deriveddata-
          
    - name: Build and Test with Coverage
      run: |
        set -o pipefail
        xcodebuild test \
          -project "${{ env.PROJECT_PATH }}" \
          -scheme "${{ env.SCHEME }}" \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=18.2" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=YES \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults.xcresult \
          2>&1 | tee build.log
          
    - name: Extract Coverage Percentage
      id: coverage
      if: success()
      run: |
        if [ -d "TestResults.xcresult" ]; then
          xcrun xccov view --report --json TestResults.xcresult > coverage.json 2>/dev/null || true
          if [ -f "coverage.json" ] && [ -s "coverage.json" ]; then
            COVERAGE=$(cat coverage.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f\"{d.get('lineCoverage', 0)*100:.1f}\")" 2>/dev/null || echo "0")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "Coverage: $COVERAGE%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "Coverage report not available"
          fi
        else
          echo "coverage=0" >> $GITHUB_OUTPUT
          echo "Test results not found"
        fi
        
    - name: Check Coverage Threshold
      if: success()
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        THRESHOLD=70
        if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
          echo "::warning::Could not determine code coverage"
        elif (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "::warning::Code coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
        else
          echo "âœ… Code coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"
        fi
          
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          TestResults.xcresult
          build.log
        if-no-files-found: ignore
