# Fastlane configuration for BombermanGame

# Autogenerated by fastlane
#
# Ensure this file is checked in to source control!

default_platform(:ios)

platform :ios do
  
  # ===========================
  # Setup
  # ===========================
  
  before_all do
    # 証明書とプロビジョニングプロファイルのセットアップ
    setup_ci if ENV['CI']
  end

  # ===========================
  # Development
  # ===========================

  desc "Development用のビルドを作成"
  lane :build_dev do
    build_app(
      scheme: "BombermanGame",
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build",
      output_name: "BombermanGame-Dev.ipa",
      skip_archive: false,
      include_bitcode: false
    )
  end

  # ===========================
  # Testing
  # ===========================

  desc "ユニットテストを実行"
  lane :test do
    run_tests(
      scheme: "BombermanGame",
      device: "iPhone 15",
      code_coverage: true,
      output_directory: "./test_output",
      output_types: "html,junit"
    )
  end

  desc "テストカバレッジレポートを生成"
  lane :coverage do
    run_tests(
      scheme: "BombermanGame",
      device: "iPhone 15",
      code_coverage: true,
      output_directory: "./coverage"
    )
    
    # xcov を使用してカバレッジレポートを生成
    xcov(
      scheme: "BombermanGame",
      output_directory: "./coverage",
      minimum_coverage_percentage: 70.0
    )
  end

  # ===========================
  # Beta Distribution
  # ===========================

  desc "TestFlight用のビルドを作成してアップロード"
  lane :beta do
    # バージョン番号をインクリメント
    increment_build_number(
      build_number: latest_testflight_build_number + 1
    )
    
    # ビルド
    build_app(
      scheme: "BombermanGame",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "BombermanGame.ipa"
    )
    
    # TestFlightにアップロード
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      changelog: changelog_from_git_commits
    )
    
    # Slackに通知（オプション）
    # slack(message: "New beta build uploaded to TestFlight!")
  end

  desc "TestFlightにビルドをアップロード（ビルド済みIPA使用）"
  lane :upload_testflight do
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY"],
      is_key_content_base64: true
    )
    
    upload_to_testflight(
      api_key: api_key,
      ipa: "./build/export/BombermanGame.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  # ===========================
  # Release
  # ===========================

  desc "App Store用のビルドを作成してアップロード"
  lane :release do
    # バージョン番号を確認
    ensure_git_status_clean
    
    # ビルド
    build_app(
      scheme: "BombermanGame",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "BombermanGame.ipa"
    )
    
    # App Store Connectにアップロード
    upload_to_app_store(
      force: true,
      skip_screenshots: true,
      skip_metadata: true,
      precheck_include_in_app_purchases: false
    )
    
    # Gitタグを作成
    add_git_tag(
      tag: "v#{get_version_number}"
    )
    
    push_git_tags
  end

  # ===========================
  # Ad Hoc Distribution
  # ===========================

  desc "Ad Hoc配布用のビルドを作成"
  lane :adhoc do
    build_app(
      scheme: "BombermanGame",
      configuration: "Release",
      export_method: "ad-hoc",
      output_directory: "./build",
      output_name: "BombermanGame-AdHoc.ipa"
    )
  end

  # ===========================
  # Certificates & Provisioning
  # ===========================

  desc "証明書とプロビジョニングプロファイルを取得"
  lane :certificates do
    match(
      type: "appstore",
      readonly: is_ci
    )
  end

  desc "開発用証明書を取得"
  lane :dev_certificates do
    match(
      type: "development",
      readonly: is_ci
    )
  end

  # ===========================
  # Utilities
  # ===========================

  desc "ビルド番号をインクリメント"
  lane :bump_build do
    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )
    commit_version_bump(
      message: "Bump build number",
      xcodeproj: "BombermanGame/BombermanGame.xcodeproj"
    )
  end

  desc "バージョン番号を更新"
  lane :bump_version do |options|
    increment_version_number(
      version_number: options[:version]
    )
    commit_version_bump(
      message: "Bump version to #{options[:version]}",
      xcodeproj: "BombermanGame/BombermanGame.xcodeproj"
    )
  end

  # ===========================
  # Error Handling
  # ===========================

  error do |lane, exception|
    # エラー発生時の処理
    # slack(
    #   message: "Error in lane #{lane}: #{exception.message}",
    #   success: false
    # )
  end

end
